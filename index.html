<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>code runners vs wix — portrait</title>
  <style>
    html, body {height:100%; margin:0; background:#0b0f14; overflow:hidden;}
    #game {width:100%; height:100%;}
    * { -webkit-tap-highlight-color: rgba(0,0,0,0); }
    body, canvas { touch-action: none; }
    .hud { position:fixed; left:12px; bottom:12px; right:12px; display:flex; justify-content:space-between; align-items:flex-end; pointer-events:none; }
    .btn { pointer-events:auto; width:72px; height:72px; border-radius:50%; border:2px solid #8aa1b8; display:flex; align-items:center; justify-content:center; color:#b9cee3; font:14px system-ui,-apple-system,Segoe UI,Roboto,sans-serif; opacity:.95; background:rgba(24,36,50,.35); backdrop-filter: blur(6px); }
    .btn:active { transform:scale(.96); }
    .col { display:flex; gap:10px; }
    .tip { position:fixed; left:50%; transform:translateX(-50%); bottom:8px; color:#8aa1b8; font:12px system-ui,-apple-system,Segoe UI,Roboto,sans-serif; opacity:.8; text-align:center; }
    /* overlay paysage */
    #rotate { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:#0b0f14; color:#b9cee3; font:16px system-ui,-apple-system,Segoe UI,Roboto,sans-serif; z-index:9999; }
    @media (orientation:landscape) {
      #rotate { display:flex; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
</head>
<body>
  <div id="game"></div>

  <!-- hud mobile -->
  <div class="hud" id="hud">
    <div class="col">
      <div id="joystick-area" style="width:160px; height:160px;"></div>
    </div>
    <div class="col">
      <button class="btn" id="btn-test" aria-label="unit test">TEST</button>
      <button class="btn" id="btn-dash" aria-label="dash">DASH</button>
    </div>
  </div>
  <div class="tip" id="tip">pouce gauche pour bouger • test et dash à droite</div>
  <div id="rotate">tournez en mode portrait pour jouer</div>

  <script>
  ;(() => {
    // dimensions portrait fixes (ratio 9:16), redimensionnées en fit
    const DESIGN_W = 540, DESIGN_H = 960;

    // audio ios
    const Audioy = {
      ctx: null, unlocked: false,
      init(){ if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)() },
      unlock(){
        this.init();
        if(this.unlocked) return;
        const resume = () => { this.ctx.resume().then(()=>{ this.unlocked = true; window.removeEventListener('touchstart', resume, true); window.removeEventListener('pointerdown', resume, true); }); };
        window.addEventListener('touchstart', resume, true);
        window.addEventListener('pointerdown', resume, true);
      },
      beep({freq=880, dur=0.08, type='sine', vol=0.03}={}){ try{ this.init(); const t=this.ctx.currentTime; const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(this.ctx.destination); o.start(t); o.stop(t+dur);}catch(e){} }
    };
    Audioy.unlock();

    class Main extends Phaser.Scene {
      constructor(){ super('main') }
      preload(){}

      create(){
        // état
        this.gameOver = false; this.score = 0; this.builds = 0; this.snippets = 0;
        this.debt = 0; this.debtRate = 2; this.lastDash = -999; this.dashCd = 1200;
        this.isDashing = false; this.wixActive = false;

        // fond
        this.drawGrid();

        // textures
        this.makeTextures();

        // joueur
        this.player = this.physics.add.sprite(this.scale.width/2, this.scale.height/2, 'player')
          .setDepth(10).setCircle(16, 0, 0);
        this.player.speed = 220; this.player.shield = null;

        // groupes
        this.enemies = this.physics.add.group();
        this.snipGroup = this.physics.add.group();
        this.projectiles = this.physics.add.group();

        // spawn
        this.time.addEvent({delay:900, loop:true, callback:()=>this.spawnEnemy()});
        this.time.addEvent({delay:1400, loop:true, callback:()=>this.spawnSnippet()});

        // ui
        this.makeUI();

        // collisions
        this.physics.add.overlap(this.player, this.snipGroup, (p,s)=>{
          s.destroy(); this.snippets++;
          if(this.snippets>=3){ this.snippets=0; this.builds++; this.flash(this.uiBuilds,'#79ffa1') }
          else { this.flash(this.uiSnip,'#ffe47a') }
          Audioy.beep({freq:1200}); this.updateUI();
        });
        this.physics.add.overlap(this.player, this.enemies, ()=>this.hit());
        this.physics.add.overlap(this.player, this.projectiles, ()=>this.hit());

        // clavier desktop
        this.cursors = this.input.keyboard.createCursorKeys();
        this.keys = this.input.keyboard.addKeys('Z,Q,S,D,E,R,SPACE');
        this.input.keyboard.on('keydown-E', ()=>this.castUnitTest());
        this.input.keyboard.on('keydown-SPACE', ()=>this.castDash());
        this.input.keyboard.on('keydown-R', ()=>this.restart());

        // planificateur wix
        this.time.addEvent({ delay:1000, loop:true, callback:()=>{
          if(this.gameOver) return;
          if(!this.wixActive){
            this.debt = Math.min(100, this.debt + this.debtRate);
            this.updateDebt(); if(this.debt>=100) this.summonWix();
          }
        }});

        // mobile ui
        this.setupMobileControls();
        this.scale.on('resize', () => { this.positionJoystick(); this.relayoutUI(); }, this);
        this.relayoutUI();
      }

      // visuels
      drawGrid(){
        const W=this.scale.width, H=this.scale.height;
        const g=this.add.graphics();
        g.fillStyle(0x0b0f14,1).fillRect(0,0,W,H);
        g.lineStyle(1,0x16202b,1);
        for(let x=0;x<=W;x+=24){ g.beginPath(); g.moveTo(x,0); g.lineTo(x,H); g.strokePath(); }
        for(let y=0;y<=H;y+=24){ g.beginPath(); g.moveTo(0,y); g.lineTo(W,y); g.strokePath(); }
        g.setDepth(0);
      }
      makeTextures(){
        const g=this.make.graphics({x:0,y:0,add:false});
        g.clear(); g.fillStyle(0x4ad1ff,1); g.fillCircle(16,16,16); g.lineStyle(2,0xffffff,1); g.strokeCircle(16,16,16);
        g.generateTexture('player',32,32);
        g.clear(); g.fillStyle(0xffcf4a,1); this.poly(g,16,16,6,12); g.lineStyle(2,0x2b2b2b,0.7); this.polyStroke(g,16,16,6,12);
        g.generateTexture('snippet',32,32);
        g.clear(); g.fillStyle(0x9b5cff,1); g.fillCircle(48,48,48); g.lineStyle(3,0xffffff,0.9); g.strokeCircle(48,48,48);
        g.generateTexture('wixboss',96,96);
        g.clear(); g.fillStyle(0xff5d7a,1); g.fillRect(0,0,26,26); g.lineStyle(2,0xffffff,0.8); g.strokeRect(1,1,24,24);
        g.generateTexture('bug',26,26);
        g.clear(); g.lineStyle(3,0x79ffa1,1); g.strokeCircle(22,22,22);
        g.generateTexture('shield',44,44);
        g.clear(); g.fillStyle(0x95a7b7,1); g.fillCircle(6,6,6);
        g.generateTexture('micro',12,12);
        g.destroy();
      }
      poly(g,x,y,sides,r){ const pts=[]; for(let i=0;i<sides;i++){ const a=(i/sides)*Math.PI*2 - Math.PI/2; pts.push({x:x+Math.cos(a)*r, y:y+Math.sin(a)*r})}; g.beginPath(); g.moveTo(pts[0].x,pts[0].y); for(let i=1;i<pts.length;i++){ g.lineTo(pts[i].x,pts[i].y)}; g.closePath(); g.fillPath(); }
      polyStroke(g,x,y,sides,r){ const pts=[]; for(let i=0;i<sides;i++){ const a=(i/sides)*Math.PI*2 - Math.PI/2; pts.push({x:x+Math.cos(a)*r, y:y+Math.sin(a)*r})}; g.beginPath(); g.moveTo(pts[0].x,pts[0].y); for(let i=1;i<pts.length;i++){ g.lineTo(pts[i].x,pts[i].y)}; g.closePath(); g.strokePath(); }

      // ui
      makeUI(){
        const style = { fontFamily:'system-ui,-apple-system,Segoe UI,Roboto,sans-serif', fontSize:'16px', color:'#b9cee3' };
        this.uiText = this.add.text(12, 10, '', style).setDepth(100);
        this.uiSnip = this.add.text(12, 34, '', style).setDepth(100);
        this.uiBuilds = this.add.text(12, 58, '', style).setDepth(100);
        this.debtBg = this.add.rectangle(DESIGN_W-212, 18, 200, 12, 0x182432).setOrigin(0,0).setDepth(100);
        this.debtFill = this.add.rectangle(DESIGN_W-212, 18, 0, 12, 0xff7ba5).setOrigin(0,0).setDepth(101);
        this.debtLbl = this.add.text(DESIGN_W-212, 34, 'dette technique', { ...style, fontSize:'12px', color:'#8aa1b8' }).setDepth(100);
        this.updateUI(); this.updateDebt();
      }
      relayoutUI(){
        const W=this.scale.width;
        this.debtBg.x = W - 212; this.debtFill.x = W - 212; this.debtLbl.x = W - 212;
      }
      updateUI(){ this.uiText.setText(`score ${Math.floor(this.score)}`); this.uiSnip.setText(`snippets ${this.snippets}/3`); this.uiBuilds.setText(`builds ${this.builds}`); }
      updateDebt(){ this.debtFill.width = 200 * (this.debt/100); }
      flash(obj,color){ const prev=obj.style.color; obj.setColor(color); this.time.delayedCall(120, ()=>obj.setColor(prev)); }

      // gameplay
      spawnEnemy(){
        if(this.gameOver) return;
        const W=this.scale.width, H=this.scale.height, edge=Phaser.Math.Between(0,3), m=30;
        const x = edge===0? -m : edge===1? W+m : Phaser.Math.Between(0,W);
        const y = edge===2? -m : edge===3? H+m : Phaser.Math.Between(0,H);
        const e=this.enemies.create(x,y,'bug');
        e.setData('speed', Phaser.Math.Between(60,110)).setBounce(1,1).setCollideWorldBounds(true);
        // étiquette "WIX" au-dessus de l’ennemi
        const label = this.add.text(e.x, e.y-20, 'WIX', { fontFamily:'system-ui,-apple-system,Segoe UI,Roboto,sans-serif', fontSize:'12px', color:'#ff99b3' }).setOrigin(0.5).setDepth(50);
        e.setData('label', label);
      }
      spawnSnippet(){
        if(this.gameOver) return;
        const W=this.scale.width, H=this.scale.height;
        const s=this.snipGroup.create(Phaser.Math.Between(40,W-40), Phaser.Math.Between(40,H-40), 'snippet');
        s.setBounce(1,1);
      }
      castUnitTest(){
        if(this.gameOver) return;
        if(this.builds<=0) return this.flash(this.uiBuilds,'#ff7b7b');
        this.builds--;
        if(this.player.shield) this.player.shield.destroy();
        const shield=this.add.sprite(this.player.x,this.player.y,'shield').setDepth(9);
        this.player.shield=shield;
        this.tweens.add({targets:shield, alpha:{from:1,to:0.5}, yoyo:true, duration:220, repeat:-1});
        this.time.delayedCall(3000, ()=>{ if(shield && shield.active){ shield.destroy(); this.player.shield=null; } });
        Audioy.beep({freq:760}); this.updateUI();
      }
      castDash(){
        if(this.gameOver) return;
        const now=Date.now(); if(now - this.lastDash < this.dashCd) return this.flash(this.uiText,'#ffb36b');
        this.lastDash=now; this.isDashing=true;
        const v=this.getMoveVector(); const mag=Math.max(1, v.length());
        const dashSpeed=480; const dx=(v.x/mag)*dashSpeed, dy=(v.y/mag)*dashSpeed;
        this.player.setVelocity(dx,dy); this.time.delayedCall(150, ()=>this.isDashing=false); Audioy.beep({freq:320});
      }
      summonWix(){
        this.wixActive=true; this.debt=100; this.updateDebt();
        this.wix=this.physics.add.sprite(-80,-80,'wixboss').setDepth(5).setImmovable(true);
        // label pour le boss aussi
        this.wixLabel = this.add.text(this.wix.x, this.wix.y-54, 'WIX', { fontFamily:'system-ui,-apple-system,Segoe UI,Roboto,sans-serif', fontSize:'14px', color:'#d7b3ff' }).setOrigin(0.5).setDepth(50);
        this.time.addEvent({delay:600, repeat:10, callback:()=>this.wixShoot()});
        this.time.delayedCall(10000, ()=>{ if(!this.wix) return; this.wix.destroy(); if(this.wixLabel) this.wixLabel.destroy(); this.wix=null; this.wixActive=false; this.debt=0; this.updateDebt(); });
      }
      wixShoot(){
        if(!this.wix || this.gameOver) return;
        const a=Phaser.Math.Angle.Between(this.wix.x,this.wix.y,this.player.x,this.player.y), step=80;
        this.wix.x += Math.cos(a)*step; this.wix.y += Math.sin(a)*step;
        if(this.wixLabel) this.wixLabel.setPosition(this.wix.x, this.wix.y-54);
        for(let i=0;i<6;i++){
          const ang=a+(i-2.5)*0.15, m=this.projectiles.create(this.wix.x,this.wix.y,'micro');
          m.setData('vx', Math.cos(ang)*140); m.setData('vy', Math.sin(ang)*140);
        }
      }
      hit(){
        if(this.gameOver) return;
        if(this.isDashing) return;
        if(this.player.shield){ return; }
        this.onDeath();
      }
      onDeath(){
        this.gameOver=true; this.player.setTint(0xff3b3b);
        const t1=this.add.text(this.scale.width/2, this.scale.height/2, 'échec du build', { fontFamily:'system-ui,-apple-system,Segoe UI,Roboto,sans-serif', fontSize:'36px', color:'#ff7b7b' }).setOrigin(0.5);
        const t2=this.add.text(this.scale.width/2, this.scale.height/2+36, 'tap test pour rejouer', { fontFamily:'system-ui,-apple-system,Segoe UI,Roboto,sans-serif', fontSize:'14px', color:'#9fb3c8' }).setOrigin(0.5);
        this.tweens.add({targets:t2, alpha:{from:1,to:0.4}, yoyo:true, duration:500, repeat:-1});
      }
      restart(){ if(!this.gameOver) return; this.scene.restart(); }

      // mouvement
      getMoveVector(){
        const k=this.keys, c=this.cursors;
        let x=0, y=0;
        if(this.joystickActive){ x += this.jvx; y += this.jvy; }
        else {
          if(k.Q.isDown || c.left.isDown) x -= 1;
          if(k.D.isDown || c.right.isDown) x += 1;
          if(k.Z.isDown || c.up.isDown) y -= 1;
          if(k.S.isDown || c.down.isDown) y += 1;
        }
        return new Phaser.Math.Vector2(x,y);
      }

      update(time, delta){
        if(this.gameOver) return;
        const v=this.getMoveVector().normalize().scale(this.player.speed);
        if(!this.isDashing) this.player.setVelocity(v.x, v.y);
        if(this.player.shield){ this.player.shield.setPosition(this.player.x, this.player.y); }
        // ennemis + mise à jour des labels
        this.enemies.children.iterate(e => {
          if(!e) return;
          const a=Phaser.Math.Angle.Between(e.x,e.y,this.player.x,this.player.y);
          const s=e.getData('speed')||80; e.setVelocity(Math.cos(a)*s, Math.sin(a)*s);
          const lbl = e.getData('label'); if(lbl) lbl.setPosition(e.x, e.y-20);
        });
        // projectiles
        this.projectiles.children.iterate(m => { if(!m) return; m.x += m.getData('vx')*delta/1000; m.y += m.getData('vy')*delta/1000;
          if(m.x<-20||m.x>this.scale.width+20||m.y<-20||m.y>this.scale.height+20) m.destroy(); });
        // score
        this.score += delta/16; this.updateUI();
      }

      // mobile controls
      setupMobileControls(){
        // boutons
        const btnTest=document.getElementById('btn-test');
        const btnDash=document.getElementById('btn-dash');
        const press=(el, down, up)=>{ const onDown=(e)=>{e.preventDefault(); down();}; const onUp=(e)=>{e.preventDefault(); up&&up();};
          el.addEventListener('touchstart', onDown, {passive:false}); el.addEventListener('pointerdown', onDown, {passive:false});
          el.addEventListener('touchend', onUp, {passive:false}); el.addEventListener('pointerup', onUp, {passive:false});
        };
        press(btnTest, ()=>{ if(this.gameOver) this.restart(); else this.castUnitTest(); });
        press(btnDash, ()=>{ if(!this.gameOver) this.castDash(); });

        // joystick virtuel
        this.joystickActive=false; this.jvx=0; this.jvy=0;
        const area=document.getElementById('joystick-area');
        const base=this.add.circle(0,0,50,0x1b2a3c,0.45).setStrokeStyle(2,0x8aa1b8,0.8).setDepth(200);
        const knob=this.add.circle(0,0,26,0x4ad1ff,0.8).setStrokeStyle(2,0xffffff,0.9).setDepth(201);
        base.setVisible(false); knob.setVisible(false);
        this.positionJoystick = ()=>{
          const r = area.getBoundingClientRect();
          this.jx = r.left + r.width/2;
          this.jy = r.top + r.height/2 + (window.scrollY||0);
          base.setPosition(this.jx, this.jy);
          knob.setPosition(this.jx, this.jy);
        };
        this.positionJoystick();

        const start=(clientX, clientY)=>{ this.joystickActive=true; base.setVisible(true); knob.setVisible(true); move(clientX, clientY); };
        const end=()=>{ this.joystickActive=false; this.jvx=0; this.jvy=0; base.setVisible(false); knob.setVisible(false); };
        const move=(clientX, clientY)=>{
          const dx=clientX - this.jx, dy=clientY - this.jy;
          const len=Math.min(Math.hypot(dx,dy), 44);
          const ang=Math.atan2(dy,dx);
          knob.setPosition(this.jx + Math.cos(ang)*len, this.jy + Math.sin(ang)*len);
          this.jvx = Math.cos(ang); this.jvy = Math.sin(ang);
          if(len<6){ this.jvx=0; this.jvy=0; }
        };

        const handleStart=(e)=>{ const t=(e.touches? e.touches[0]: e); start(t.clientX, t.clientY); e.preventDefault(); };
        const handleMove =(e)=>{ const t=(e.touches? e.touches[0]: e); move(t.clientX, t.clientY); e.preventDefault(); };
        const handleEnd  =(e)=>{ end(); e.preventDefault(); };

        area.addEventListener('touchstart', handleStart, {passive:false});
        area.addEventListener('touchmove',  handleMove,  {passive:false});
        area.addEventListener('touchend',   handleEnd,   {passive:false});
        area.addEventListener('pointerdown',handleStart, {passive:false});
        window.addEventListener('pointermove', (e)=>{ if(this.joystickActive) handleMove(e); }, {passive:false});
        window.addEventListener('pointerup', handleEnd, {passive:false});
        window.addEventListener('resize', ()=>this.positionJoystick());
        window.addEventListener('orientationchange', ()=>setTimeout(()=>this.scale.refresh(), 150));
      }
    }

    const config = {
      type: Phaser.AUTO,
      parent: 'game',
      width: DESIGN_W,
      height: DESIGN_H,
      backgroundColor: '#0b0f14',
      scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
      physics: { default: 'arcade', arcade: { gravity: {y:0}, debug: false } },
      scene: [Main]
    };
    const game = new Phaser.Game(config);
  })()
  </script>
</body>
</html>
